#@ load("@ytt:data", "data")
#@yaml/text-templated-strings

#@ def generate_tags(builder):
#@   tags = builder.stack
#@   for stack in data.values.stacks:
#@     if stack.name == builder.stack:
#@       tags += " " + stack.tag
#@     end
#@   end
#@   if builder.latest:
#@     tags += " latest"
#@   end
#@   return tags
#@ end

#@ def cnbs_for_builder(builder):
#@   cnbs = []
#@   for cnb in data.values.cnbs:
#@     include_cnb = True
#@     for stack in cnb.skip_stack:
#@       if stack == builder.stack:
#@         include_cnb = False
#@       end
#@     end
#@     if include_cnb:
#@       cnbs.append(cnb)
#@     end
#@   end
#@   return cnbs
#@ end

---
resource_types:
  - name: cron
    type: docker-image
    source:
      repository: cfbuildpacks/cron-resource

resources:
- name: buildpacks-ci
  type: git
  source:
    uri: https://github.com/cloudfoundry/buildpacks-ci
    branch: master

- name: bre-ci
  type: git
  source:
    uri: git@github.com:pivotal/bre-ci.git
    private_key: ((bre-ci-deploy-key.private_key))
    branch: master

- name: cnb-builder
  type: git
  source:
    uri: https://github.com/cloudfoundry/cnb-builder
    branch: master

#@ for cnb in data.values.cnbs:
- name: #@ cnb.name + "-cnb-release"
  type: git
  check_every: 15m #! to avoid thundering herd of cnb autobumping
  source:
    uri: #@ cnb.git_repo
    private_key: ((cf-buildpacks-eng-github-ssh-key.private_key))
    tag_filter: 'v*'
#@ end

- name: packager
  type: git
  source:
    uri: https://github.com/cloudfoundry/libcfbuildpack
    branch: master

- name: pack-release
  type: github-release
  source:
    user: buildpacks
    repository: pack
    access_token: ((buildpacks-github-token))
    globs: ['*-linux.tgz']

- name: cnb-lifecycle-release
  type: github-release
  source:
    repository: lifecycle
    user: buildpacks
    access_token: ((buildpacks-github-token))

#@ for version in data.values.supported_lifecycle_versions:
- name: #@ "cnb-lifecycle-release-" + version
  type: github-release
  source:
    repository: lifecycle
    user: buildpacks
    access_token: ((buildpacks-github-token))
#@ end

- name: lifecycle-metadata-file
  type: s3
  source:
    bucket: lifecycle-metadata
    access_key_id: ((lifecycle-metadata-s3-access-key))
    secret_access_key: ((lifecycle-metadata-s3-secret-key))
    versioned_file: lifecycle-metadata.json

#! Versions
#@ for builder in data.values.builders:
- name: #@ builder.version_key + "-version"
  type: semver
  source:
    initial_version: 0.0.1
    bucket: cnb-versions
    key: #@ "builder/" + builder.version_key
    access_key_id: ((pivotal-offline-buildpacks-s3-access-key))
    secret_access_key: ((pivotal-offline-buildpacks-s3-secret-key))

#! Docker Images
- name: #@ builder.name + "-builder-image"
  type: registry-image
  source:
    repository: #@ builder.repository
    tag: #@ builder.stack
    username: ((buildpacks-docker-user.username))
    password: ((buildpacks-docker-user.password))

- name: #@ builder.name + "-rc-image"
  type: registry-image
  source:
    repository: gcr.io/cf-buildpacks/builder-rcs
    tag: #@ builder.name
    username: _json_key
    password: ((gcp-service-account-key))
#@ end

#@ for stack in data.values.stacks:
  #@ for image in data.values.images:
- name: #@ "{}-{}-cnb-image".format(stack.name, image)
  type: registry-image
  source:
    repository: #@ "cloudfoundry/" + image
    tag: #@ stack.tag + "-cnb"
    username: ((buildpacks-docker-user.username))
    password: ((buildpacks-docker-user.password))
  #@ end
#@ end

- name: ci-image
  type: registry-image
  source:
    repository: cfbuildpacks/ci
    username: ((buildpacks-docker-user.username))
    password: ((buildpacks-docker-user.password))

jobs:
- name: pin-cnb-lifecycle-releases
  plan:
  - in_parallel:
    - get: bre-ci
    - get: lifecycle-metadata-file
    - get: cnb-lifecycle-release
      trigger: true
#@ for version in data.values.supported_lifecycle_versions:
    - get: #@ "cnb-lifecycle-release-" +version
#@ end
  - task: get-platform-api-version
    file: bre-ci/tasks/get-platform-api-version/task.yml
  - task: update-lifecycle-metadata
    file: bre-ci/tasks/update-lifecycle-platform-api-mappings/task.yml
  - task: pin-cnb-lifecycle-releases
    file: bre-ci/tasks/pin-cnb-lifecycle-releases/task.yml
    params:
      CONCOURSE_USERNAME: ((concourse_user.username))
      CONCOURSE_PASSWORD: ((concourse_user.password))
      CONCOURSE_TEAM: releng
  - put: lifecycle-metadata-file
    params:
      file: lifecycle-metadata-file/lifecycle-metadata.json

#@ for version in data.values.supported_lifecycle_versions:
  #@ for builder in data.values.builders:
- name: #@ "create-{}-builder-rc-platform-api-{}".format(builder.name, version)
  plan:
    - in_parallel:
      - get: buildpacks-ci
      - get: ci-image
      - get: packager
      - get: pack
        resource: pack-release
        trigger: true
      - get: lifecycle
        resource: #@ "cnb-lifecycle-release-" + version
        passed: [ pin-cnb-lifecycle-releases ]
        trigger: true
      - get: #@ builder.stack + "-build-cnb-image"
        trigger: true
      - get: #@ builder.stack + "-run-cnb-image"
        trigger: true
    #@ for cnb in cnbs_for_builder(builder):
      - get: #@ cnb.name + "-cnb"
        resource: #@ cnb.name + "-cnb-release"
        trigger: true
    #@ end
      - get: cnb-builder
      - get: version
        resource: #@ builder.version_key + "-version"
        params:
          pre: rc
    - task: get-cnb-sources
      image: ci-image
      config:
        platform: linux
        inputs:
    #@ for cnb in cnbs_for_builder(builder):
          - name: #@ cnb.name + "-cnb"
    #@ end
        outputs:
          - name: sources
        run:
          path: bash
          args:
            - -cl
            - cp -r *-cnb sources/
    - task: create-builder-image
      image: ci-image
      file: buildpacks-ci/tasks/create-builder/task.yml
      privileged: true
      params:
        REPO: cloudfoundry/cnb
        STACK: #@ builder.builder_image_stack
        BUILD_IMAGE: #@ "cloudfoundry/build:" + builder.builder_image_name
        RUN_IMAGE: #@ "cloudfoundry/run:" + builder.builder_image_name
        HOST: "hub.docker.com"
    - task: get-platform-api-version
      file: bre-ci/tasks/get-platform-api-version/task.yml
    - task: write-tags-list
      file: buildpacks-ci/tasks/write-tags-list/task.yml
      params:
        TAGS: #@ generate_tags(builder)
    - put: #@ builder.name + "-rc-image"
      params:
        additional_tags: tags/tags
        image: builder-image/builder.tgz
    - put: version
      resource: #@ builder.version_key + "-version"
      params:
        file: version/version

- name: #@ "test-{}-builder-rc-platform-api-{}".format(builder.name, version)
  plan:
    - in_parallel:
      - get: buildpacks-ci
      - get: ci-image
      - get: version
        resource: #@ builder.version_key + "-version"
        passed: #@ ["create-{}-builder-rc-platform-api-{}".format(builder.name, version)]
      - get: builder-image
        resource: #@ builder.name + "-rc-image"
        trigger: true
        passed: #@ ["create-{}-builder-rc-platform-api-{}".format(builder.name, version)]
        params:
          format: oci
      - get: pack
        resource: pack-release
      - get: cnb-builder
    - task: smoke-test-builder
      image: ci-image
      file: buildpacks-ci/tasks/test-builder/task.yml
      privileged: true
      params:
        STACK: #@ builder.name
        REPO: gcr.io/cf-buildpacks/builder-rcs
        RUN_IMAGE: #@ "cloudfoundry/run:" + builder.builder_image_name
    - task: builder-release-story
      image: ci-image
      file: buildpacks-ci/tasks/builder-release-story/task.yml
      params:
        GCP_SERVICE_ACCOUNT_KEY: ((gcp-service-account-key))
        TAG: #@ builder.name
        TRACKER_API_TOKEN: ((pivotal-tracker-api-token))
        TRACKER_PROJECT_ID: ((cf-buildpacks-releng-tracker-id))
        BEFORE_STORY_ID: ((builder_release_marker_story_number))

- name: #@ "ship-{}-builder-platform-api-{}".format(builder.name, version)
  plan:
    - in_parallel:
      - get: ci-image
      - get: buildpacks-ci
      - get: #@ builder.name + "-rc-image"
        passed: #@ ["test-{}-builder-rc-platform-api-{}".format(builder.name, version)]
        trigger: true
        params:
          format: oci
      - get: version
        resource: #@ builder.version_key + "-version"
        passed: #@ ["test-{}-builder-rc-platform-api-{}".format(builder.name, version)]
        params:
          bump: final
          pre: #@ builder.name
          pre_without_version: true
    - task: get-platform-api-version
      file: bre-ci/tasks/get-platform-api-version/task.yml
    - task: write-tags-list
      file: buildpacks-ci/tasks/write-tags-list/task.yml
      params:
        TAGS: #@ generate_tags(builder)
    - put: #@ builder.name + "-builder-image"
      params:
        additional_tags: tags/tags
        image: #@ builder.name + "-rc-image/image.tar"
    - put: version
      resource: #@ builder.version_key + "-version"
      params:
        bump: patch
  #@ end
#@ end

groups:
- name: all
  jobs:
  - pin-cnb-lifecycle-releases
#@ for version in data.values.supported_lifecycle_versions:
  #@ for builder in data.values.builders:
  - #@ "create-{}-builder-rc-platform-api-{}".format(builder.name, version)
  - #@ "test-{}-builder-rc-platform-api-{}".format(builder.name, version)
  - #@ "ship-{}-builder-platform-api-{}".format(builder.name, version)
  #@ end
#@ end

#@ for builder in data.values.builders:
- name: #@ builder.name + "-builder"
  jobs:
  #@ for version in data.values.supported_lifecycle_versions:
  - #@ "create-{}-builder-rc-platform-api-{}".format(builder.name, version)
  - #@ "test-{}-builder-rc-platform-api-{}".format(builder.name, version)
  - #@ "ship-{}-builder-platform-api-{}".format(builder.name, version)
  #@ end
#@ end

#@ for version in data.values.supported_lifecycle_versions:
- name: #@ "platform-api-" + version
  jobs:
  #@ for builder in data.values.builders:
  - #@ "create-{}-builder-rc-platform-api-{}".format(builder.name, version)
  - #@ "test-{}-builder-rc-platform-api-{}".format(builder.name, version)
  - #@ "ship-{}-builder-platform-api-{}".format(builder.name, version)
  #@ end
#@ end
