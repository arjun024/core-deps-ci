#@ load("@ytt:data", "data")
#@yaml/text-templated-strings

#@ def get_base_image(stack, image):
#@   base_image = stack.name
#@   if stack.name == "tiny" and image == "build":
#@       base_image = "base"
#@   end
#@
#@   return base_image
#@ end

#@ def has_base_image(stack, image):
#@   if stack.name == "tiny" and image == "build":
#@       return False
#@   end
#@
#@   return True
#@ end

#@ def get_dockerfile_dir_name(name, image):
#@   result = name
#@
#@   if name != "full-cf":
#@     if image == "build" or name != "tiny":
#@       result = "bionic"
#@     end
#@   end
#@
#@   return result
#@ end
---
resource_types:
- name: cron
  type: docker-image
  source:
    repository: cfbuildpacks/cron-resource

resources:
#! Github Repos
- name: buildpacks-ci
  type: git
  source:
    uri: https://github.com/cloudfoundry/buildpacks-ci
    branch: master

- name: bre-ci
  type: git
  source:
    uri: git@github.com:pivotal/bre-ci.git
    private_key: ((bre-ci-deploy-key.private_key))

- name: stacks
  type: git
  source:
    uri: https://github.com/paketo-buildpacks/stacks

#@ for stack in data.values.stacks:
  #@ if stack.name != "tiny" and stack.name != "full-cf":
    #@ for image in data.values.images:
- name: #@ "{}-{}-new-usns-related".format(stack.name, image)
  type: git
  source:
    uri: git@github.com:cloudfoundry/public-buildpacks-ci-robots
    branch: main
    paths:
    - #@ "new-paketo-stack-usns/{}/{}/ubuntu18.04.yml".format(stack.name, image)
    private_key: ((public-buildpacks-ci-robots-deploy-key.private_key))
- name: #@ "{}-{}-new-usns".format(stack.name, image)
  type: git
  source:
    uri: git@github.com:cloudfoundry/public-buildpacks-ci-robots
    branch: main
    paths:
    - #@ "new-paketo-stack-usns/{}/{}/*".format(stack.name, image)
    private_key: ((public-buildpacks-ci-robots-deploy-key.private_key))
    #@ end
  #@ end
#@ end

- name: cflinuxfs3-image
  type: docker-image
  source:
    repository: cloudfoundry/cflinuxfs3
    username: ((buildpacks-docker-user.username))
    password: ((buildpacks-docker-user.password))
    email: cf-buildpacks-eng@pivotal.io

#! Dockerfiles
#@ for image in data.values.images:
- name: #@ "bionic-{}-cnb-dockerfile".format(image)
  type: git
  source:
    uri: https://github.com/paketo-buildpacks/stacks
    paths: #@ [ "bionic/cnb/{}/**".format(image) ]

- name: #@ "bionic-{}-base-dockerfile".format(image)
  type: git
  source:
    uri: https://github.com/paketo-buildpacks/stacks
    paths: #@ [ "bionic/dockerfile/{}/**".format(image) ]
#@ end

#@ for stack in data.values.stacks:
  #@ for image in stack.base_images:
    #@ if get_dockerfile_dir_name(stack.name, image) != "bionic":
- name: #@ "{}-{}-cnb-dockerfile".format(stack.name, image)
  type: git
  source:
    uri: https://github.com/paketo-buildpacks/stacks
    paths: #@ [ "{}/cnb/{}/**".format(stack.name, image) ]

      #@ if stack.build_base:
- name: #@ "{}-{}-base-dockerfile".format(stack.name, image)
  type: git
  source:
    uri: https://github.com/paketo-buildpacks/stacks
    paths: #@ [ "{}/dockerfile/{}/**".format(stack.name, image) ]
      #@ end
    #@ end

#! CNB stack images
- name: #@ "{}-{}-base-image-rc".format(stack.name, image)
  type: registry-image
  source:
    repository: #@ "gcr.io/cf-buildpacks-releng/{}-rc".format(image)
    tag: #@ stack.name
    username: _json_key
    password: ((releng-gcp-service-account-key))

- name: #@ "{}-{}-base-image".format(stack.name, image)
  type: registry-image
  source:
    repository: #@ "gcr.io/paketo-buildpacks/" + image
    tag: #@ stack.name
    username: _json_key
    password: ((paketo-gcr-service-account-key))

    #@ if stack.name != "full":
- name: #@ "{}-{}-cloudfoundry-base-image".format(stack.name, image)
  type: registry-image
  source:
    repository: #@ "cloudfoundry/" + image
      #@ if stack.name != "full-cf":
    tag: #@ stack.name
      #@ else:
    tag: full
      #@ end
    username: ((buildpacks-docker-user.username))
    password: ((buildpacks-docker-user.password))
    #@ end

- name: #@ "{}-{}-cnb-image-rc".format(stack.name, image)
  type: registry-image
  source:
    repository: #@ "gcr.io/cf-buildpacks-releng/{}-rc".format(image)
    #@ if stack.name != "full-cf":
    tag: #@ stack.name + "-cnb"
    #@ else:
    tag: full-cnb-cf
    #@ end
    username: _json_key
    password: ((releng-gcp-service-account-key))

    #@ if stack.name != "full":
- name: #@ "{}-{}-cnb-image".format(stack.name, image)
  type: registry-image
  source:
    repository: #@ "gcr.io/paketo-buildpacks/" + image
    #@ if stack.name != "full-cf":
    tag: #@ stack.name + "-cnb"
    #@ else:
    tag: full-cnb-cf
    #@ end
    username: _json_key
    password: ((paketo-gcr-service-account-key))
    #@ end

- name: #@ "{}-{}-dockerhub-cnb-image".format(stack.name, image)
  type: registry-image
  source:
    repository: #@ "paketobuildpacks/" + image
    #@ if stack.name != "full-cf":
    tag: #@ stack.name + "-cnb"
    #@ else:
    tag: full-cnb-cf
    #@ end
    username: ((paketo-docker-user.username))
    password: ((paketo-docker-user.password))

    #@ if stack.name != "full-cf":
- name: #@ "{}-{}-dockerhub-image".format(stack.name, image)
  type: registry-image
  source:
    repository: #@ "paketobuildpacks/" + image
    tag: #@ stack.name
    username: ((paketo-docker-user.username))
    password: ((paketo-docker-user.password))
    #@ end

    #@ if stack.name != "full":
- name: #@ "{}-{}-cloudfoundry-cnb-image".format(stack.name, image)
  type: registry-image
  source:
    repository: #@ "cloudfoundry/" + image
      #@ if stack.name != "full-cf":
    tag: #@ stack.name + "-cnb"
      #@ else:
    tag: full-cnb
      #@ end
    username: ((buildpacks-docker-user.username))
    password: ((buildpacks-docker-user.password))
    #@ end

#! Package lists
    #@ if get_dockerfile_dir_name(stack.name, image) == "bionic":
- name: #@ "{}-{}-package-list".format(stack.name, image)
  type: git
  source:
    uri: https://github.com/paketo-buildpacks/stacks
    paths: #@ [ "packages/{}/{}".format(stack.name, image) ]
    #@ end
  #@ end

#! Versions
- name: #@ "{}-version".format(stack.name)
  type: semver
  source:
    initial_version: 0.0.1
    bucket: stack-versions
    key: #@ stack.name
    access_key_id: ((pivotal-offline-buildpacks-s3-access-key))
    secret_access_key: ((pivotal-offline-buildpacks-s3-secret-key))

#! Mixins
  #@ if stack.mixins:
- name: #@ stack.name + "-build-mixins"
  type: s3
  source:
    bucket: stack-mixins
    versioned_file: #@ stack.name + "-build-mixins.json"
    access_key_id: ((pivotal-offline-buildpacks-s3-access-key))
    secret_access_key: ((pivotal-offline-buildpacks-s3-secret-key))

- name: #@ stack.name + "-run-mixins"
  type: s3
  source:
    bucket: stack-mixins
    versioned_file: #@ stack.name + "-run-mixins.json"
    access_key_id: ((pivotal-offline-buildpacks-s3-access-key))
    secret_access_key: ((pivotal-offline-buildpacks-s3-secret-key))
  #@ end

#! Tags
- name: #@ stack.name + "-base-image-tags"
  type: s3
  source:
    bucket: stack-tags
    versioned_file: #@ stack.name + "-base-image-tags"
    access_key_id: ((pivotal-offline-buildpacks-s3-access-key))
    secret_access_key: ((pivotal-offline-buildpacks-s3-secret-key))

- name: #@ stack.name + "-cnb-image-tags"
  type: s3
  source:
    bucket: stack-tags
    versioned_file: #@ stack.name + "-cnb-image-tags"
    access_key_id: ((pivotal-offline-buildpacks-s3-access-key))
    secret_access_key: ((pivotal-offline-buildpacks-s3-secret-key))

  #@ if stack.name == "full-cf":
- name: #@ stack.name + "-base-image-tags-cf"
  type: s3
  source:
    bucket: stack-tags
    versioned_file: #@ stack.name + "-base-image-tags-cf"
    access_key_id: ((pivotal-offline-buildpacks-s3-access-key))
    secret_access_key: ((pivotal-offline-buildpacks-s3-secret-key))

- name: #@ stack.name + "-cnb-image-tags-cf"
  type: s3
  source:
    bucket: stack-tags
    versioned_file: #@ stack.name + "-cnb-image-tags-cf"
    access_key_id: ((pivotal-offline-buildpacks-s3-access-key))
    secret_access_key: ((pivotal-offline-buildpacks-s3-secret-key))
  #@ end

#! Stack image receipts
- name: #@ "{}-receipt-s3".format(stack.name)
  type: s3
  source:
    bucket: stack-receipts
    versioned_file: #@ "{}-receipt".format(stack.name)
    access_key_id: ((pivotal-offline-buildpacks-s3-access-key))
    secret_access_key: ((pivotal-offline-buildpacks-s3-secret-key))
#@ end

- name: base-build-receipt-s3
  type: s3
  source:
    bucket: stack-receipts
    versioned_file: base-build-receipt
    access_key_id: ((pivotal-offline-buildpacks-s3-access-key))
    secret_access_key: ((pivotal-offline-buildpacks-s3-secret-key))

#! Tiny's build image is a re-tagged version of the bionic image (and not built from a dockerfile)
#! so it is a special case
- name: tiny-build-cnb-image-rc
  type: registry-image
  source:
    repository: gcr.io/cf-buildpacks-releng/build-rc
    tag: tiny-cnb
    username: _json_key
    password: ((releng-gcp-service-account-key))

- name: tiny-build-cnb-image
  type: registry-image
  source:
    repository: gcr.io/paketo-buildpacks/build
    tag: tiny-cnb
    username: _json_key
    password: ((paketo-gcr-service-account-key))

- name: tiny-build-dockerhub-cnb-image
  type: registry-image
  source:
    repository: paketobuildpacks/build
    tag: tiny-cnb
    username: ((paketo-docker-user.username))
    password: ((paketo-docker-user.password))

- name: tiny-build-cloudfoundry-cnb-image
  type: registry-image
  source:
    repository: cloudfoundry/build
    tag: tiny-cnb
    username: ((buildpacks-docker-user.username))
    password: ((buildpacks-docker-user.password))

#! Timers
- name: every-hour
  type: cron
  source:
    expression: "0 * * * *"
    location: America/New_York
- name: every-sunday-morning
  type: cron
  source:
    expression: "0 8 * * 0"
    location: America/New_York

jobs:
- name: test-tiny
  plan:
    - get: tiny-run-base-dockerfile
      trigger: true
    - get: buildpacks-ci
    - task: integration-test
      privileged: true
      file: buildpacks-ci/tasks/test-tiny-docker-image/task.yml

#@ for stack in data.values.stacks:
- name: #@ "create-{}-base-image-rcs".format(stack.name)
  serial: true
  public: true
  plan:
  #@ dir_name = get_dockerfile_dir_name(stack.name, "")
    - in_parallel:
      - get: bre-ci
      - get: stacks
    #@ for image in stack.base_images:
      #@ if stack.name != "full-cf":
      - get: #@ "{}-{}-base-dockerfile".format(dir_name, image)
        trigger: true
        #@ if stack.name == "tiny":
        passed: [test-tiny]
        #@ end
        #@ if stack.name != "tiny":
      - get: #@ "{}-{}-package-list".format(stack.name, image)
        trigger: true
        #@ end
      #@ end
      - get: #@ "{}-{}-cnb-dockerfile".format(dir_name, image)
        trigger: true
    #@ end
    #@ if stack.name == "tiny":
      - get: base-build-base-image-rc
        trigger: true
    #@ end
    #@ if stack.name != "tiny" and stack.name != "full-cf":
      #@ for image in stack.base_images:
      - get: #@ "{}-{}-new-usns-related".format(stack.name, image)
        trigger: true
      #@ end
    #@ end
    #@ if stack.name == "full-cf":
      - get: #@ stack.name + "-image"
        resource: cflinuxfs3-image
        trigger: true
        params:
          save: true
    #@ end
      - get: version
        resource: #@ stack.name + "-version"
        params:
          bump: patch
          pre: #@ stack.name
          pre_without_version: true
      - get: every-sunday-morning
        trigger: true
    #@ if stack.name != "full-cf":
    - in_parallel:
      #@ for image in stack.base_images:
      - do:
        #@ if stack.name != "tiny":
        - task: write-build-args-file
          file: bre-ci/tasks/write-build-args-file/task.yml
          params:
            STACK: #@ stack.name
            IMAGE: #@ image
          output_mapping:
            build-args: #@ image + "-build-args"
        #@ end
        - task: #@ "build-{}-{}-base-image".format(stack.name, image)
          privileged: true
          file: bre-ci/tasks/build-stack-image/task.yml
          input_mapping:
            #@ if stack.name != "tiny":
            build-args: #@ image + "-build-args"
            #@ end
          params:
            #@ if stack.name != "tiny":
            BUILD_ARGS_FILE: build-args/args
            #@ end
            CONTEXT: #@ "stacks/{}/dockerfile/{}".format(dir_name, image)
        - put: #@ "{}-{}-base-image-rc".format(stack.name, image)
          params:
            additional_tags: version/version
            image: image/image.tar
      #@ end
    #@ else:
    - task: write-tags-list
      file: bre-ci/tasks/write-tags-list/task.yml
      params:
        REMOVE_CF_SUFFIX: true
    - in_parallel:
      #@ for image in stack.base_images:
      - put: #@ "{}-{}-base-image-rc".format(stack.name, image)
        params:
          additional_tags: version/version
          image: #@ stack.name + "-image/image"
      #@ end
      - put: #@ stack.name + "-base-image-tags-cf"
        params:
          file: tags/tags-cf
    #@ end
    - in_parallel:
      - put: #@ stack.name + "-base-image-tags"
        params:
          file: version/version
      - put: version
        resource: #@ "{}-version".format(stack.name)
        params:
          bump: patch

  #@ if stack.mixins:
- name: #@ "generate-mixins-labels-{}-cnb-image".format(stack.name)
  public: true
  plan:
  #@ dir_name = get_dockerfile_dir_name(stack.name, "")
    - in_parallel:
      - get: bre-ci
      #@ for image in stack.base_images:
      - get: #@ "{}-{}-cnb-dockerfile".format(dir_name, image)
        passed: #@ [ "create-{}-base-image-rcs".format(stack.name) ]
      - get: #@ "{}-{}-base-image-rc".format(stack.name, image)
        trigger: true
        passed: #@ [ "create-{}-base-image-rcs".format(stack.name) ]
      #@ end
      - get: version
        resource: #@ stack.name + "-version"
        passed: #@ [ "create-{}-base-image-rcs".format(stack.name) ]
        params:
          pre: #@ stack.name
          pre_without_version: true
      - get: base-image-tags
        resource: #@ stack.name + "-base-image-tags"
        passed: #@ [ "create-{}-base-image-rcs".format(stack.name) ]
      #@ if stack.name == "full-cf":
      - get: base-image-tags-cf
        resource: #@ stack.name + "-base-image-tags-cf"
        passed: #@ [ "create-{}-base-image-rcs".format(stack.name) ]
      #@ end
    - in_parallel:
      - task: write-build-package-list
        file: bre-ci/tasks/write-package-list/task.yml
        image: #@ "{}-build-base-image-rc".format(stack.name)
        output_mapping:
          package-list: build-image-package-list
      - task: write-run-package-list
        file: bre-ci/tasks/write-package-list/task.yml
        image: #@ "{}-run-base-image-rc".format(stack.name)
        output_mapping:
          package-list: run-image-package-list
    - task: write-mixins-labels
      file: bre-ci/tasks/write-mixins-labels/task.yml
      input_mapping:
        build-base-dockerfile: #@ "{}-build-cnb-dockerfile".format(dir_name)
        run-base-dockerfile: #@ "{}-run-cnb-dockerfile".format(dir_name)
      params:
        STACK: #@ dir_name
    - in_parallel:
      - put: #@ stack.name + "-build-mixins"
        params:
          file: build-mixins-label/mixins.json
      - put: #@ stack.name + "-run-mixins"
        params:
          file: run-mixins-label/mixins.json
  #@ end

- name: #@ "create-{}-cnb-image-rcs".format(stack.name)
  public: true
  plan:
    - in_parallel:
      - get: bre-ci
    #@ if stack.name == "tiny":
      - get: tiny-run-base-dockerfile
        passed: [create-tiny-base-image-rcs]
    #@ end
    #@ for image in data.values.images:
      #@ dir_name = get_dockerfile_dir_name(stack.name, image)
      #@ base_image = get_base_image(stack, image)
      - get: #@ "{}-{}-cnb-dockerfile".format(dir_name, image)
        #@ if has_base_image(stack, image):
        trigger: true
        #@ end
      #@ if stack.mixins:
        passed: #@ [ "generate-mixins-labels-{}-cnb-image".format(base_image) ]
      #@ elif has_base_image(stack, image):
        passed: #@ [ "create-{}-base-image-rcs".format(base_image) ]
      #@ end
      - get: #@ "{}-{}-base-image-rc".format(base_image, image)
        #@ if has_base_image(stack, image):
        trigger: true
        #@ end
        passed:
      #@ if stack.mixins:
        - #@ "generate-mixins-labels-{}-cnb-image".format(base_image)
      #@ else:
        - #@ "create-{}-base-image-rcs".format(stack.name, image)
      #@ end
      #@ if stack.mixins:
      - get: #@ "{}-{}-mixins".format(stack.name, image)
        passed: #@ [ "generate-mixins-labels-{}-cnb-image".format(base_image) ]
      #@ end
    #@ end
      - get: version
        resource: #@ stack.name + "-version"
        #@ if stack.mixins:
        passed: #@ [ "generate-mixins-labels-{}-cnb-image".format(stack.name) ]
        #@ else:
        passed: #@ [ "create-{}-base-image-rcs".format(stack.name) ]
        #@ end
        params:
        #@ if stack.name != "full-cf":
          pre: #@ stack.name + "-cnb"
        #@ else:
          pre: full-cnb-cf
        #@ end
          pre_without_version: true
      - get: base-image-tags
        resource: #@ stack.name + "-base-image-tags"
        #@ if stack.mixins:
        passed: #@ [ "generate-mixins-labels-{}-cnb-image".format(stack.name) ]
        #@ else:
        passed: #@ [ "create-{}-base-image-rcs".format(stack.name) ]
        #@ end
        #@ if stack.name == "full-cf":
      - get: base-image-tags-cf
        resource: #@ stack.name + "-base-image-tags-cf"
        passed: #@ [ "create-{}-base-image-rcs".format(stack.name) ]
        #@ end
    - task: write-tags-list
      file: bre-ci/tasks/write-tags-list/task.yml
      params:
        #@ if stack.latest:
        TAGS: latest
        #@ end
        #@ if stack.name == "full-cf":
        REMOVE_CF_SUFFIX: true
        #@ end
    - in_parallel:
    #@ for image in data.values.images:
      #@ dir_name = get_dockerfile_dir_name(stack.name, image)
      #@ base_image = get_base_image(stack, image)
      - do:
        - task: write-build-args-file
          file: bre-ci/tasks/write-build-args-file/task.yml
          params:
            BASE_IMAGE: #@ "gcr.io/cf-buildpacks-releng/{}-rc:{}".format(image, base_image)
            #@ if stack.name == "tiny":
            STACK_ID: #@ stack.id
            #@ end
          #@ if stack.mixins:
          input_mapping:
            mixins-label: #@ "{}-{}-mixins".format(stack.name, image)
          #@ end
          output_mapping:
            build-args: #@ image + "-build-args"
        - task: write-docker-creds
          file: bre-ci/tasks/write-docker-creds/task.yml
          params:
            USERNAME: _json_key
            PASSWORD: ((releng-gcp-service-account-key))
        - task: #@ "build-{}-{}-cnb-image-rc".format(stack.name, image)
          privileged: true
          file: bre-ci/tasks/build-stack-image/task.yml
          input_mapping:
            stacks: #@ "{}-{}-cnb-dockerfile".format(dir_name, image)
            build-args: #@ image + "-build-args"
          output_mapping:
            image: #@ image + "-image"
          params:
            CONTEXT: #@ "stacks/{}/cnb/{}".format(dir_name, image)
            BUILD_ARGS_FILE: build-args/args
        - put: #@ "{}-{}-cnb-image-rc".format(stack.name, image)
          params:
            additional_tags: tags/tags
            image: #@ image + "-image/image.tar"
    #@ end
    - in_parallel:
      - put: #@ stack.name + "-cnb-image-tags"
        params:
          file: tags/tags
      #@ if stack.name == "full-cf":
      - put: #@ stack.name + "-cnb-image-tags-cf"
        params:
          file: tags/tags-cf
      #@ end

- name: #@ "test-{}-cnb-image-rcs".format(stack.name)
  public: true
  plan:
    - in_parallel:
      - get: bre-ci
      - get: version
        resource: #@ stack.name + "-version"
        passed: #@ [ "create-{}-cnb-image-rcs".format(stack.name) ]
        params:
          pre: #@ stack.name
          pre_without_version: true
      #@ for image in data.values.images:
      - get: #@ "{}-{}-cnb-image-rc".format(stack.name, image)
        trigger: true
        passed: #@ [ "create-{}-cnb-image-rcs".format(stack.name) ]
        #@ base_image = get_base_image(stack, image)
      - get: #@ "{}-{}-base-image-rc".format(base_image, image)
        trigger: true
        passed: #@ [ "create-{}-cnb-image-rcs".format(stack.name) ]
      #@ end
      - get: base-image-tags
        resource: #@ stack.name + "-base-image-tags"
        passed: #@ [ "create-{}-cnb-image-rcs".format(stack.name) ]
      - get: cnb-image-tags
        resource: #@ stack.name + "-cnb-image-tags"
        passed: #@ [ "create-{}-cnb-image-rcs".format(stack.name) ]
      #@ if stack.name == "full-cf":
      - get: base-image-tags-cf
        resource: #@ stack.name + "-base-image-tags-cf"
        passed: #@ [ "create-{}-cnb-image-rcs".format(stack.name) ]
      - get: cnb-image-tags-cf
        resource: #@ stack.name + "-cnb-image-tags-cf"
        passed: #@ [ "create-{}-cnb-image-rcs".format(stack.name) ]
      #@ end
    #@ if stack.name == "tiny":
      - get: tiny-run-base-dockerfile
        passed: [create-tiny-cnb-image-rcs]
      - get: tiny-run-cnb-dockerfile
        passed: [create-tiny-cnb-image-rcs]
    #@ end
    - task: #@ "test-{}-cnb-image-rcs".format(stack.name)
      privileged: true
      file: bre-ci/tasks/test-stack/task.yml
      params:
        STACK_ID: #@ stack.id
        GCP_SERVICE_ACCOUNT_KEY: ((releng-gcp-service-account-key))
        #@ if stack.name != "full-cf":
        BUILD_IMAGE: #@ "gcr.io/cf-buildpacks-releng/build-rc:{}-cnb".format(stack.name)
        RUN_IMAGE: #@ "gcr.io/cf-buildpacks-releng/run-rc:{}-cnb".format(stack.name)
        #@ else:
        BUILD_IMAGE: gcr.io/cf-buildpacks-releng/build-rc:full-cnb-cf
        RUN_IMAGE: gcr.io/cf-buildpacks-releng/run-rc:full-cnb-cf
        #@ end

- name: #@ "check-for-{}-receipt-diff".format(stack.name)
  public: true
  plan:
  - in_parallel:
    - get: bre-ci
    - get: #@ "{}-receipt-s3".format(stack.name)
  #@ if stack.name == "base":
    - get: base-build-receipt-s3
  #@ end
  #@ if stack.name == "tiny":
    - get: tiny-run-base-dockerfile
      passed: [test-tiny-cnb-image-rcs]
    - get: tiny-run-cnb-dockerfile
      passed: [test-tiny-cnb-image-rcs]
  #@ else:
    #@ for image in data.values.images:
    - get: #@ "{}-{}-base-image-rc".format(stack.name, image)
      passed:
      - #@ "test-{}-cnb-image-rcs".format(stack.name)
    #@ end
  #@ end
  #@ if stack.name == "tiny":
  - task: generate-stack-receipt
    file: bre-ci/tasks/write-tiny-stack-receipt/task.yml
  - task: check-for-receipt-diff
    file: bre-ci/tasks/check-for-receipt-diff/task.yml
    input_mapping:
      receipt: tiny-stack-receipt
      receipt-s3: tiny-receipt-s3
    params:
      AWS_ACCESS_KEY_ID: ((pivotal-offline-buildpacks-s3-access-key))
      AWS_SECRET_ACCESS_KEY: ((pivotal-offline-buildpacks-s3-secret-key))
      BUCKET: stack-receipts
      RECEIPT_FILENAME: tiny-receipt
  #@ else:
  - in_parallel:
    #@ for image in data.values.images:
    - do:
      - task: generate-stack-image-receipt
        file: bre-ci/tasks/write-stack-image-receipt/task.yml
        image: #@ "{}-{}-base-image-rc".format(stack.name, image)
        output_mapping:
          stack-image-receipt: #@ "{}-{}-receipt".format(stack.name, image)
    #@ end
  - task: generate-stack-receipt
    file: bre-ci/tasks/write-stack-receipt/task.yml
    input_mapping:
      build-receipt: #@ "{}-build-receipt".format(stack.name)
      run-receipt: #@ "{}-run-receipt".format(stack.name)
    output_mapping:
      stack-receipt: #@ "{}-receipt".format(stack.name)
  - task: check-for-receipt-diff
    file: bre-ci/tasks/check-for-receipt-diff/task.yml
    input_mapping:
      receipt: #@ "{}-receipt".format(stack.name)
      receipt-s3: #@ "{}-receipt-s3".format(stack.name)
    params:
      AWS_ACCESS_KEY_ID: ((pivotal-offline-buildpacks-s3-access-key))
      AWS_SECRET_ACCESS_KEY: ((pivotal-offline-buildpacks-s3-secret-key))
      BUCKET: stack-receipts
      RECEIPT_FILENAME: #@ "{}-receipt".format(stack.name)
    #@ if stack.name == "base":
  - task: check-for-base-build-receipt-diff
    file: bre-ci/tasks/check-for-receipt-diff/task.yml
    input_mapping:
      receipt: base-build-receipt
      receipt-s3: base-build-receipt-s3
    params:
      AWS_ACCESS_KEY_ID: ((pivotal-offline-buildpacks-s3-access-key))
      AWS_SECRET_ACCESS_KEY: ((pivotal-offline-buildpacks-s3-secret-key))
      BUCKET: stack-receipts
      RECEIPT_FILENAME: base-build-receipt
    #@ end
  #@ end

- name: #@ "upload-{}-images".format(stack.name)
  public: true
  plan:
    - in_parallel:
      - get: bre-ci
      - get: #@ "{}-receipt-s3".format(stack.name)
        trigger: true
  #@ if stack.name == "tiny":
      - get: base-build-receipt-s3
        trigger: true
  #@ end
      - get: version
        resource: #@ stack.name + "-version"
        passed: #@ [ "test-{}-cnb-image-rcs".format(stack.name) ]
        params:
          pre: #@ stack.name
          pre_without_version: true
      #@ for image in data.values.images:
        #@ if has_base_image(stack, image):
      - get: #@ image + "-base-image"
        resource: #@ "{}-{}-base-image-rc".format(stack.name, image)
        passed: #@ [ "test-{}-cnb-image-rcs".format(stack.name) ]
        params:
          format: oci
        #@ end
      - get: #@ image + "-cnb-image"
        resource: #@ "{}-{}-cnb-image-rc".format(stack.name, image)
        passed: #@ [ "test-{}-cnb-image-rcs".format(stack.name) ]
        params:
          format: oci
      #@ end
      - get: base-image-tags
        resource: #@ stack.name + "-base-image-tags"
        passed: #@ [ "test-{}-cnb-image-rcs".format(stack.name) ]
      - get: cnb-image-tags
        resource: #@ stack.name + "-cnb-image-tags"
        passed: #@ [ "test-{}-cnb-image-rcs".format(stack.name) ]
      #@ if stack.name == "full-cf":
      - get: base-image-tags-cf
        resource: #@ stack.name + "-base-image-tags-cf"
        passed: #@ [ "test-{}-cnb-image-rcs".format(stack.name) ]
      - get: cnb-image-tags-cf
        resource: #@ stack.name + "-cnb-image-tags-cf"
        passed: #@ [ "test-{}-cnb-image-rcs".format(stack.name) ]
      #@ end
    - task: check-if-stack-version-exists
      file: bre-ci/tasks/check-if-stack-version-exists/task.yml
    - in_parallel:
      #@ for image in stack.base_images:
      - put: #@ "{}-{}-base-image".format(stack.name, image)
        params:
          additional_tags: #@ "base-image-tags/{}-base-image-tags".format(stack.name)
          image: #@ image + "-base-image/image.tar"
        #@ if stack.name != "full":
      - put: #@ "{}-{}-cloudfoundry-base-image".format(stack.name, image)
        params:
          #@ if stack.name != "full-cf":
          additional_tags: #@ "base-image-tags/{}-base-image-tags".format(stack.name)
          #@ else:
          additional_tags: #@ "base-image-tags-cf/{}-base-image-tags-cf".format(stack.name)
          #@ end
          image: #@ image + "-base-image/image.tar"
        #@ end
        #@ if stack.name != "full-cf":
      - put: #@ "{}-{}-dockerhub-image".format(stack.name, image)
        params:
          additional_tags: #@ "base-image-tags/{}-base-image-tags".format(stack.name)
          image: #@ image + "-base-image" + "/image.tar"
        #@ end
      #@ end
      #@ for image in data.values.images:
      - put: #@ "{}-{}-dockerhub-cnb-image".format(stack.name, image)
        params:
          additional_tags: #@ "cnb-image-tags/{}-cnb-image-tags".format(stack.name)
          image: #@ image + "-cnb-image/image.tar"
        #@ if stack.name != "full":
      - put: #@ "{}-{}-cnb-image".format(stack.name, image)
        params:
          additional_tags: #@ "cnb-image-tags/{}-cnb-image-tags".format(stack.name)
          image: #@ image + "-cnb-image/image.tar"
      - put: #@ "{}-{}-cloudfoundry-cnb-image".format(stack.name, image)
        params:
          #@ if stack.name != "full-cf":
          additional_tags: #@ "cnb-image-tags/{}-cnb-image-tags".format(stack.name)
          #@ else:
          additional_tags: #@ "cnb-image-tags-cf/{}-cnb-image-tags-cf".format(stack.name)
          #@ end
          image: #@ image + "-cnb-image/image.tar"
        #@ end
      #@ end

  #@ if stack.name != "tiny" and stack.name != "full-cf":
- name: #@ "new-usns-{}".format(stack.name)
  public: true
  plan:
  - in_parallel:
    - get: bre-ci
    - get: buildpacks-ci
    - get: every-hour
      trigger: true
    #@ for image in data.values.images:
    - get: #@ "{}-{}-new-usns".format(stack.name, image)
    - get: #@ "{}-{}-base-image".format(stack.name, image)
    #@ end
  - in_parallel:
    #@ for image in data.values.images:
    - do:
      - task: generate-stack-image-receipt
        file: bre-ci/tasks/write-stack-image-receipt/task.yml
        image: #@ "{}-{}-base-image".format(stack.name, image)
        output_mapping:
          stack-image-receipt: #@ "{}-{}-stack-image-receipt".format(stack.name, image)
      - task: check-for-new-usns
        file: buildpacks-ci/tasks/check-for-new-paketo-stack-usns/task.yml
        params:
          STACK: #@ stack.name
          IMAGE: #@ image
        input_mapping:
          new-usns: #@ "{}-{}-new-usns".format(stack.name, image)
          stack-image-receipt: #@ "{}-{}-stack-image-receipt".format(stack.name, image)
        output_mapping:
          new-usns: #@ "{}-{}-new-usns".format(stack.name, image)
      - put: #@ "{}-{}-new-usns".format(stack.name, image)
        params:
          repository: #@ "{}-{}-new-usns".format(stack.name, image)
          rebase: true
    #@ end
  #@ end
#@ end

groups:
- name: all
  jobs:
    - test-tiny
#@ for stack in data.values.stacks:
  #@ if stack.mixins:
    - #@ "generate-mixins-labels-{}-cnb-image".format(stack.name)
  #@ end
    - #@ "create-{}-base-image-rcs".format(stack.name)
    - #@ "create-{}-cnb-image-rcs".format(stack.name)
    - #@ "test-{}-cnb-image-rcs".format(stack.name)
    - #@ "upload-{}-images".format(stack.name)
    - #@ "check-for-{}-receipt-diff".format(stack.name)
  #@ if stack.name != "tiny" and stack.name != "full-cf":
    - #@ "new-usns-{}".format(stack.name)
  #@ end
#@ end

#@ for stack in data.values.stacks:
- name: #@ stack.name
  jobs:
  #@ if stack.mixins:
    - #@ "generate-mixins-labels-{}-cnb-image".format(stack.name)
  #@ end
  #@ if stack.name == "tiny":
    - test-tiny
  #@ end
  #@ if stack.name != "tiny" and stack.name != "full-cf":
    - #@ "new-usns-{}".format(stack.name)
  #@ end
    - #@ "create-{}-base-image-rcs".format(stack.name)
    - #@ "create-{}-cnb-image-rcs".format(stack.name)
    - #@ "test-{}-cnb-image-rcs".format(stack.name)
    - #@ "check-for-{}-receipt-diff".format(stack.name)
    - #@ "upload-{}-images".format(stack.name)
#@ end

- name: new-usns
  jobs:
#@ for stack in data.values.stacks:
  #@ if stack.name != "tiny" and stack.name != "full-cf":
    - #@ "new-usns-{}".format(stack.name)
  #@ end
#@ end
