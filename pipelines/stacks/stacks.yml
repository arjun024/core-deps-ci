#@ load("@ytt:data", "data")
#@yaml/text-templated-strings
---
resources:
#! Github Repos
- name: buildpacks-ci
  type: git
  source:
    uri: https://github.com/cloudfoundry/buildpacks-ci
    branch: master

- name: bre-ci
  type: git
  source:
    uri: git@github.com:pivotal/bre-ci.git
    private_key: ((bre-ci-deploy-key.private_key))
    branch: master

- name: new-cves
  type: git
  source:
    uri: git@github.com:cloudfoundry/public-buildpacks-ci-robots
    branch: master
    paths: [ new-cve-notifications/ubuntu18.04-tiny.yml ]
    private_key: ((public-buildpacks-ci-robots-deploy-key.private_key))

- name: cflinuxfs3-image
  type: docker-image
  source:
    repository: cloudfoundry/cflinuxfs3
    username: ((buildpacks-docker-user.username))
    password: ((buildpacks-docker-user.password))
    email: cf-buildpacks-eng@pivotal.io

- name: bionic-image
  type: docker-image
  source:
    repository: ubuntu
    tag: bionic

#! CNB stack images
#@ for stack in data.values.stacks:
  #@ for image in stack.images:
- name: #@ "{}-{}-base-image".format(stack.name, image)
  type: registry-image
  source:
    repository: #@ "gcr.io/paketo-buildpacks/" + image
    #@ if stack.tag != "full":
    tag: #@ stack.tag
    #@ else:
    tag: full-cf
    #@ end
    username: _json_key
    password: ((paketo-gcr-service-account-key))

- name: #@ "{}-{}-cloudfoundry-base-image".format(stack.name, image)
  type: registry-image
  source:
    repository: #@ "cloudfoundry/" + image
    tag: #@ stack.tag
    username: ((buildpacks-docker-user.username))
    password: ((buildpacks-docker-user.password))

- name: #@ "{}-{}-cnb-image".format(stack.name, image)
  type: registry-image
  source:
    repository: #@ "gcr.io/paketo-buildpacks/" + image
    #@ if stack.tag != "full":
    tag: #@ stack.tag + "-cnb"
    #@ else:
    tag: full-cnb-cf
    #@ end
    username: _json_key
    password: ((paketo-gcr-service-account-key))

- name: #@ "{}-{}-cloudfoundry-cnb-image".format(stack.name, image)
  type: registry-image
  source:
    repository: #@ "cloudfoundry/" + image
    tag: #@ stack.tag + "-cnb"
    username: ((buildpacks-docker-user.username))
    password: ((buildpacks-docker-user.password))

#! Dockerfiles
- name: #@ "{}-{}-cnb-dockerfile".format(stack.name, image)
  type: git
  source:
    uri: https://github.com/cloudfoundry/stacks
    branch: master
    paths: #@ [ "{}/cnb/{}/**".format(stack.name, image) ]

  #@ if stack.build_base:
- name: #@ "{}-{}-base-dockerfile".format(stack.name, image)
  type: git
  source:
    uri: https://github.com/cloudfoundry/stacks
    branch: master
    paths: #@ [ "{}/dockerfile/{}/**".format(stack.tag, image) ]
  #@ end

#! Versions
- name: #@ "{}-{}-cnb-version".format(stack.name, image)
  type: semver
  source:
    initial_version: 0.0.1
    bucket: cnb-versions
    key: #@ "builder/{}-{}-cnb".format(stack.name, image)
    access_key_id: ((pivotal-offline-buildpacks-s3-access-key))
    secret_access_key: ((pivotal-offline-buildpacks-s3-secret-key))

- name: #@ "{}-{}-base-version".format(stack.name, image)
  type: semver
  source:
    initial_version: 0.0.1
    bucket: cnb-versions
    key: #@ "builder/{}-{}-base".format(stack.name, image)
    access_key_id: ((pivotal-offline-buildpacks-s3-access-key))
    secret_access_key: ((pivotal-offline-buildpacks-s3-secret-key))
  #@ end
#@ end

#! Tiny's build image is a re-tagged version of the bionic image (and not built from a dockerfile)
#! so it is a special case
- name: tiny-build-cnb-image
  type: registry-image
  source:
    repository: gcr.io/paketo-buildpacks/build
    tag: tiny-cnb
    username: _json_key
    password: ((paketo-gcr-service-account-key))

- name: tiny-build-cloudfoundry-cnb-image
  type: registry-image
  source:
    repository: cloudfoundry/build
    tag: tiny-cnb
    username: ((buildpacks-docker-user.username))
    password: ((buildpacks-docker-user.password))

- name: tiny-build-cnb-version
  type: semver
  source:
    initial_version: 0.0.1
    bucket: cnb-versions
    key: builder/tiny-build-cnb
    access_key_id: ((pivotal-offline-buildpacks-s3-access-key))
    secret_access_key: ((pivotal-offline-buildpacks-s3-secret-key))

jobs:
- name: test-tiny
  plan:
    - get: tiny-run-base-dockerfile
      trigger: true
    - get: buildpacks-ci
    - get: new-cves
      trigger: true
    - task: integration-test
      privileged: true
      file: buildpacks-ci/tasks/test-tiny-docker-image/task.yml

- name: update-tiny-build-cnb-image
  public: true
  plan:
    - get: bre-ci
    - get: bionic-build-cnb-dockerfile
      trigger: true
    - get: bionic-build-base-image
      trigger: true
      passed:
        - update-bionic-build-base-image
    - get: version
      resource: tiny-build-cnb-version
      params:
        pre: tiny-cnb
        pre_without_version: true
    - task: build-tiny-build-cnb-image
      privileged: true
      file: bre-ci/tasks/build-stack-image/task.yml
      input_mapping:
        stacks: bionic-build-cnb-dockerfile
      params:
        CONTEXT: bionic-build-cnb-dockerfile/base/cnb/build
        BUILD_ARG_base_image: "cloudfoundry/build:base"
        BUILD_ARG_stack_id: "org.cloudfoundry.stacks.tiny"
    - put: tiny-build-cnb-image
      params:
        additional_tags: version/version
        image: image/image.tar
    - put: tiny-build-cloudfoundry-cnb-image
      params:
        additional_tags: version/version
        image: image/image.tar
    - put: version
      resource: tiny-build-cnb-version
      params:
        bump: patch

#@ for stack in data.values.stacks:
  #@ for image in stack.images:
- name: #@ "update-{}-{}-base-image".format(stack.name, image)
  public: true
  plan:
    - get: bre-ci
    #@ if stack.name != "cflinuxfs3":
    - get: #@ "{}-{}-base-dockerfile".format(stack.name, image)
      trigger: true
      #@ if stack.name == "tiny":
      passed: [test-tiny]
    - get: new-cves
      passed: [test-tiny]
      trigger: true
      #@ end
    #@ else:
    - get: #@ stack.name + "-image"
      trigger: true
      params:
        save: true
    #@ end
    - get: bionic-image
      trigger: true
    - get: version
      resource: #@ "{}-{}-base-version".format(stack.name, image)
      params:
        pre: #@ stack.tag
        pre_without_version: true
    #@ if stack.name != "cflinuxfs3":
    - task: #@ "build-{}-{}-base-image".format(stack.name, image)
      privileged: true
      file: bre-ci/tasks/build-stack-image/task.yml
      input_mapping:
        stacks: #@ "{}-{}-base-dockerfile".format(stack.name, image)
      params:
        CONTEXT: #@ "{}-{}-base-dockerfile/{}/dockerfile/{}".format(stack.name, image, stack.tag, image)
    #@ end
    - put: #@ "{}-{}-base-image".format(stack.name, image)
      params:
        additional_tags: version/version
        #@ if stack.name != "cflinuxfs3":
        image: image/image.tar
        #@ else:
        image: #@ stack.name + "-image"
        #@ end
    - put: #@ "{}-{}-cloudfoundry-base-image".format(stack.name, image)
      params:
        additional_tags: version/version
        #@ if stack.name != "cflinuxfs3":
        image: image/image.tar
        #@ else:
        image: #@ stack.name + "-image"
        #@ end
    - put: version
      resource: #@ "{}-{}-base-version".format(stack.name, image)
      params:
        bump: patch

- name: #@ "update-{}-{}-cnb-image".format(stack.name, image)
  public: true
  plan:
    - get: bre-ci
    - get: #@ "{}-{}-cnb-dockerfile".format(stack.name, image)
      trigger: true
    - get: #@ "{}-{}-base-image".format(stack.name, image)
      trigger: true
      passed: #@ [ "update-{}-{}-base-image".format(stack.name, image) ]
    - get: version
      resource: #@ "{}-{}-cnb-version".format(stack.name, image)
      params:
        pre: #@ stack.tag + "-cnb"
        pre_without_version: true
    - task: #@ "build-{}-{}-cnb-image".format(stack.name, image)
      privileged: true
      file: bre-ci/tasks/build-stack-image/task.yml
      input_mapping:
        stacks: #@ "{}-{}-cnb-dockerfile".format(stack.name, image)
      params:
        CONTEXT: #@ "{}-{}-cnb-dockerfile/{}/cnb/{}".format(stack.name, image, stack.tag, image)
        BUILD_ARG_base_image: #@ "cloudfoundry/{}:{}".format(image, stack.tag)
    - task: write-tags-list
      file: bre-ci/tasks/write-tags-list/task.yml
      params:
        #@ if stack.latest:
        TAGS: latest
        #@ end
    - put: #@ "{}-{}-cnb-image".format(stack.name, image)
      params:
        additional_tags: tags/tags
        image: image/image.tar
    - put: #@ "{}-{}-cloudfoundry-cnb-image".format(stack.name, image)
      params:
        additional_tags: tags/tags
        image: image/image.tar
    - put: version
      resource: #@ "{}-{}-cnb-version".format(stack.name, image)
      params:
        bump: patch
  #@ end
#@ end

groups:
- name: all
  jobs:
    - test-tiny
    - update-tiny-build-cnb-image
#@ for stack in data.values.stacks:
  #@ for image in stack.images:
    - #@ "update-{}-{}-base-image".format(stack.name, image)
    - #@ "update-{}-{}-cnb-image".format(stack.name, image)
  #@ end
#@ end

#@ for stack in data.values.stacks:
- name: #@ stack.name
  jobs:
    #@ if stack.name == "tiny":
    - test-tiny
    - update-tiny-build-cnb-image
    #@ end
  #@ for image in stack.images:
    - #@ "update-{}-{}-base-image".format(stack.name, image)
    - #@ "update-{}-{}-cnb-image".format(stack.name, image)
  #@ end
#@ end
